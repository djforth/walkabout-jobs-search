{"version":3,"sources":["../../src/stores/data_store.js"],"names":[],"mappings":"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","file":"data_store.js","sourcesContent":["const EventEmitter  = require(\"events\").EventEmitter;\nconst assign        = require(\"react/lib/Object.assign\");\nconst _             = require(\"lodash\");\n\nconst DataDispatcher = require(\"../dispatcher/data_dispatcher\");\nconst DataAction     = require(\"../actions/data_actions\");\nconst FilterStore    = require(\"./filter_store\");\nconst TabsStore      = require(\"./tabs_store\");\n\nconst DataFcty = require(\"../factories/data_fcty\");\n\n// let data =  new DataFcty();\n// console.count(\"Data\")\n\n\n// var searchVal;\n// var pagination = 50;\n// var page       = 1;\n// var itemNo     = 0;\n// var cache;\n// var selected = [];\n\n\n\nconst store = {\n\n  cache      : null,\n  data       : new DataFcty(),\n  dateRanges : {},\n  flash      :null,\n  itemNo     : 0,\n  removed    : null,\n  pagination : 50,\n  page       : 1,\n  searchVal  :null,\n  selected   : [],\n\n\n\n  emitChange(event) {\n    this.emit(event);\n  },\n\n  /**\n   * @param {function} callback\n   */\n  addChangeListener(event, callback) {\n    this.on(event, callback);\n  },\n\n  removeChangeListener(event, callback) {\n    this.removeListener(event, callback);\n  },\n\n  checkDeleted(id){\n    return this.removed === id;\n  },\n\n  deleteItem(id, fl){\n\n    if(fl.type === \"notice\"){\n      this.removed = id;\n      this.data.remove(id);\n\n      if(this.cache){\n        this.cache.remove(id);\n      }\n\n    }\n\n    this.flash = fl;\n  },\n\n\n\n  fetchData(progress){\n    console.log('GET DATA');\n    return this.data.fetch(progress)\n      .then(\n        this.processData.bind(this)\n      )\n      .catch((err)=>{\n        let error = new Error(err);\n        throw error;\n      });\n  },\n\n  get(id) {\n    return this.data.findById(id);\n  },\n\n  getAll() {\n    if(!_.isEmpty(this.searchVal)){\n      return this.getSearchData();\n    } else {\n      this.cache = this.data.getAll();\n      return this.cache.slice(0, this.pagination - 1);\n    }\n\n  },\n\n  getFlash(){\n    return this.flash;\n  },\n\n  getByIds(ids) {\n    return this.data.filterByIds(ids);\n  },\n\n  getCurrentData(){\n    return this.data.getAll();\n  },\n\n  getDateFmt(item, key, fmt=\"%d/%m/%Y\"){\n    return this.data.formatDate(item, key, fmt);\n  },\n\n  getKeys(){\n    return this.data.getKeys();\n  },\n\n  getPage(){\n    let i  = this.page - 1;\n    let st = i * this.pagination;\n    let fn = (st + this.pagination) - 1;\n\n    return {st:st, fn:fn};\n  },\n\n  getPagination(){\n    let no = this.itemNo / this.pagination;\n    if( no < 1 ){\n      return 0;\n    } else {\n      return Math.ceil(no);\n    }\n  },\n\n  getSearchData(){\n    this.page      = 1;\n    let keys       = FilterStore.getSelectedKeys();\n    let filters    = FilterStore.getFilters();\n    let dateRanges = FilterStore.getDates();\n    let tab        = TabsStore.getActive();\n    let search = this.data.search(this.searchVal, keys, filters, dateRanges, tab);\n    this.itemNo = search.size;\n    this.cache  = search;\n    // console.log(\"search\", search.size)\n    return search.slice(0, this.pagination - 1);\n  },\n\n  getSearchVal(){\n    return this.searchVal;\n  },\n\n  paginationData(){\n    let page = this.getPage();\n    return this.cache.slice(page.st, page.fn);\n  },\n\n  processData(){\n    if(!_.isEmpty(this.selected)){\n      this.data.addSelected(this.selected);\n    }\n\n    let d = this.data.getAll();\n    console.log(d)\n    this.itemNo = (d.size) ? d.size : 0;\n\n    // simulate success callback\n    DataAction.receiveAll(d);\n\n    return d;\n  },\n\n  removeDateRange(key){\n    this.dateRanges = _.omit(this.dateRanges, key);\n  },\n\n  setApi(uri){\n    this.data.url = uri;\n  },\n\n  setDateRanges(key, st, fn){\n    if(_.isDate(st) && _.isDate(fn)){\n      this.dateRanges[key] = {\n        st:st,\n        fn:fn\n      };\n    }\n  },\n\n  setPage(p){\n    this.page = p;\n  },\n\n  setSearchVal(val){\n    this.searchVal = val;\n  },\n\n  selectedIds(ids){\n    this.selected = ids;\n  },\n\n  setSelected(id, selected=true){\n\n    this.data.update(id, {selected:selected});\n    if(this.cache){\n      this.cache = this.cache.map((c)=>{\n        if(c){\n          if(c && c.get(\"id\") === id){\n            c = c.set(\"selected\", selected);\n          }\n          return c;\n        }\n      });\n    }\n\n  }\n};\n\nconst DataStore = assign({}, EventEmitter.prototype, store);\nDataStore.setMaxListeners(0);\n\nconst registeredCallback = function(payload) {\n  var action = payload.action;\n\n  switch(action.type) {\n    case \"ADD_DATE_RANGE\":\n      DataStore.setDateRanges(action.key, action.st, action.fn);\n      DataStore.emitChange(\"search\");\n      break;\n\n    case \"DELETE_ITEM\":\n      DataStore.deleteItem(action.id, action.flash);\n      DataStore.emitChange(\"delete\");\n      break;\n\n    case \"KEY_UPDATE\":\n      DataStore.emitChange(\"search\");\n      break;\n\n    case \"FETCH_DATA\":\n      DataStore.setApi(action.api);\n      DataStore.fetchData(action.progress);\n      DataStore.emitChange(\"fetching\");\n      break;\n\n    case \"FILTER_SEARCH\":\n      DataStore.emitChange(\"search\");\n      break;\n\n    case \"PAGE_UPDATE\":\n      DataStore.setPage(action.data);\n      DataStore.emitChange(\"pagination\");\n      break;\n\n    case \"RECEIVE_DATA\":\n      DataStore.emitChange(\"fetched\");\n      break;\n\n    case \"REMOVE_DATE_RANGE\":\n      DataStore.removeDateRange(action.key);\n      DataStore.emitChange(\"search\");\n      break;\n\n    case \"SEARCH_DATA\":\n      DataStore.setSearchVal(action.data);\n      DataStore.emitChange(\"search\");\n      break;\n\n    case \"SET_SELECTED\":\n      DataStore.setSelected(action.id, action.selected);\n      DataStore.emitChange(\"change\");\n      break;\n  }\n};\n\nDataStore.dispatchToken = DataDispatcher.register(registeredCallback);\n\nmodule.exports = DataStore;\n"]}